name: "Run Tests"
description: "Run tests with configurable command and environment"

inputs:
  test-command:
    description: "Command to run tests"
    required: true
  environment:
    description: "Environment to run tests in (development, production, test)"
    required: false
    default: "development"

runs:
  using: "composite"
  steps:
    - name: Run tests
      shell: bash
      run: |
        # Check if NODE_ENV or NODE_OPTIONS are already set in the test command
        echo "ğŸ” DEBUG: test-command input = '${{ inputs.test-command }}'"
        echo "ğŸ” DEBUG: environment input = '${{ inputs.environment }}'"

        HAS_NODE_ENV=$(echo "${{ inputs.test-command }}" | grep -q "NODE_ENV=" && echo "true" || echo "false")
        HAS_NODE_OPTIONS=$(echo "${{ inputs.test-command }}" | grep -q "NODE_OPTIONS=" && echo "true" || echo "false")

        echo "ğŸ” DEBUG: HAS_NODE_ENV = $HAS_NODE_ENV"
        echo "ğŸ” DEBUG: HAS_NODE_OPTIONS = $HAS_NODE_OPTIONS"

        if [[ "$HAS_NODE_ENV" == "true" || "$HAS_NODE_OPTIONS" == "true" ]]; then
          # If either NODE_ENV or NODE_OPTIONS is in the command, run as-is to preserve user's settings
          echo "ğŸ” DEBUG: Using command as-is (user provided env vars)"
          ${{ inputs.test-command }}
        else
          # If no NODE environment variables in command, set our defaults
          echo "ğŸ” DEBUG: Setting environment variables - NODE_ENV='${{ inputs.environment }}' NODE_OPTIONS='--conditions=${{ inputs.environment }}'"
          export NODE_ENV="${{ inputs.environment }}"
          export NODE_OPTIONS="--conditions=${{ inputs.environment }}"
          echo "ğŸ” DEBUG: Verifying environment variables are set:"
          echo "ğŸ” DEBUG: NODE_ENV=$NODE_ENV"
          echo "ğŸ” DEBUG: NODE_OPTIONS=$NODE_OPTIONS"
          echo "ğŸ” DEBUG: About to run: ${{ inputs.test-command }}"
          ${{ inputs.test-command }}
        fi
