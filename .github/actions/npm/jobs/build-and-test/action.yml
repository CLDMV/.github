name: "Build and Test NPM Package"
description: "Composite action for building and testing NPM packages"

inputs:
  node-version:
    description: "Node.js version to use"
    required: false
    default: "lts/*"
  package-manager:
    description: "Package manager (npm or yarn)"
    required: false
    default: "npm"
  test-command:
    description: "Command to run pre-build tests"
    required: false
    default: "npm test"
  build-command:
    description: "Command to build package"
    required: false
    default: "npm run build:ci"

runs:
  using: composite
  steps:
    - name: Checkout code
      uses: CLDMV/.github/.github/actions/common/steps/checkout-code@v1

    - name: Setup Node.js
      uses: CLDMV/.github/.github/actions/common/steps/setup-node@v1
      with:
        node-version: ${{ inputs.node-version }}

    - name: Install dependencies
      uses: CLDMV/.github/.github/actions/npm/steps/install-dependencies@v1
      with:
        package-manager: ${{ inputs.package-manager }}

    - name: Run pre-build tests
      uses: CLDMV/.github/.github/actions/common/steps/run-tests@v1
      with:
        test-command: ${{ inputs.test-command }}
        environment: development

    - name: Build package
      uses: CLDMV/.github/.github/actions/common/steps/build-project@v1
      with:
        build-command: ${{ inputs.build-command }}
        environment: production

    - name: Upload build artifacts
      uses: CLDMV/.github/.github/actions/common/steps/upload-artifacts@v1
      with:
        artifact-name: build-artifacts
        artifact-path: |
          dist/
          lib/
          build/
          *.tgz
          package.json
          package-lock.json
          yarn.lock
        retention-days: 1
