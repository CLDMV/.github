name: "Create Package Files for Release"
description: "Creates .tar.gz and .zip files from package contents for release assets"

inputs:
  package-path:
    description: "Path to the .tgz package file from npm pack"
    required: false
    default: "*.tgz"

outputs:
  tar-gz-path:
    description: "Path to the created .tar.gz package file"
    value: ${{ steps.create.outputs.tar-gz-path }}
  zip-path:
    description: "Path to the created .zip package file"
    value: ${{ steps.create.outputs.zip-path }}

runs:
  using: "composite"
  steps:
    - name: Create package files from npm pack
      id: create
      shell: bash
      run: |
        # Find the .tgz file from npm pack
        TGZ_FILE=$(find . -name "${{ inputs.package-path }}" -type f | head -1)

        if [ -z "$TGZ_FILE" ]; then
          echo "❌ No .tgz file found matching pattern: ${{ inputs.package-path }}"
          exit 1
        fi

        echo "📦 Found npm pack file: $TGZ_FILE"

        # Get package name from the tgz filename
        PACKAGE_NAME=$(basename "$TGZ_FILE" .tgz)

        # Create temp directory for extraction
        TEMP_DIR=$(mktemp -d)

        # Extract npm pack contents
        echo "📂 Extracting npm pack contents..."
        tar -xzf "$TGZ_FILE" -C "$TEMP_DIR"

        # Create output files with proper naming
        TAR_GZ_PATH="${PACKAGE_NAME}.tar.gz"
        ZIP_PATH="${PACKAGE_NAME}.zip"

        # Create .tar.gz from extracted contents
        echo "🗜️ Creating .tar.gz file..."
        cd "$TEMP_DIR"
        tar -czf "../$TAR_GZ_PATH" .
        cd - > /dev/null

        # Create .zip from extracted contents
        echo "� Creating .zip file..."
        cd "$TEMP_DIR"
        zip -r "../$ZIP_PATH" .
        cd - > /dev/null

        # Cleanup temp directory
        rm -rf "$TEMP_DIR"

        # Get absolute paths
        TAR_GZ_ABS=$(realpath "$TAR_GZ_PATH")
        ZIP_ABS=$(realpath "$ZIP_PATH")

        echo "✅ Created package files:"
        echo "  - TAR.GZ: $TAR_GZ_ABS"
        echo "  - ZIP: $ZIP_ABS"

        # Output paths
        echo "tar-gz-path=$TAR_GZ_ABS" >> $GITHUB_OUTPUT
        echo "zip-path=$ZIP_ABS" >> $GITHUB_OUTPUT
