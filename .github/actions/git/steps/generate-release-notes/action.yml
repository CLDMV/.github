name: "Generate Release Notes"
description: "Generate comprehensive release notes from git history"

inputs:
  version:
    description: "Version number for the release"
    required: true
  package-name:
    description: "Name of the package being released"
    required: true
  package-manager:
    description: "Package manager used (npm or yarn)"
    required: false
    default: "npm"

outputs:
  release-notes:
    description: "Generated release notes in markdown format"
    value: ${{ steps.generate.outputs.release-notes }}

runs:
  using: "composite"
  steps:
    - name: Get commit range for release notes
      id: commit-range
      uses: ./.github/actions/git/steps/get-commit-range
      with:
        debug: "false"

    - name: Generate release notes
      id: generate
      shell: bash
      run: |
        VERSION="${{ inputs.version }}"
        COMMIT_RANGE="${{ steps.commit-range.outputs.commit-range }}"
        LAST_TAG="${{ steps.commit-range.outputs.last-tag }}"
        HAS_COMMITS="${{ steps.commit-range.outputs.has-commits }}"
        
        echo "ðŸ“‹ Generating release notes for version: $VERSION"
        echo "ðŸ“‹ Commit range: $COMMIT_RANGE"
        echo "ðŸ“‹ Base tag: $LAST_TAG"

        echo "## ï¿½ What's Changed" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md

        if [ "$HAS_COMMITS" = "false" ]; then
          echo "â„¹ï¸ No commits found in range - this may be a re-release or tag-only release"
          echo "_No new commits since last release_" >> RELEASE_NOTES.md
        else
          # Check for release commits first (these are usually the most important)
          RELEASE_COMMITS=$(git log $COMMIT_RANGE --grep="^release:" --pretty=format:"- %s (%h)" | head -5)
          if [[ -n "$RELEASE_COMMITS" ]]; then
            echo "### ðŸŽ¯ Release Highlights" >> RELEASE_NOTES.md
            echo "$RELEASE_COMMITS" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Breaking Changes (exclude release commits)
          echo "### ðŸ’¥ Breaking Changes" >> RELEASE_NOTES.md
          BREAKING=$(git log $COMMIT_RANGE --grep="!" --pretty=format:"- %s (%h)" | grep -v "^- release" | head -10 || true)
          BREAKING_BODY=$(git log $COMMIT_RANGE --grep="BREAKING CHANGE" --pretty=format:"- %s (%h)" | grep -v "^- release" | head -10 || true)
        if [[ -n "$BREAKING" ]] || [[ -n "$BREAKING_BODY" ]]; then
          echo "$BREAKING" >> RELEASE_NOTES.md
          echo "$BREAKING_BODY" >> RELEASE_NOTES.md
        else
          echo "_No breaking changes_" >> RELEASE_NOTES.md
        fi
        echo "" >> RELEASE_NOTES.md

        # Features (exclude release commits)
        echo "### âœ¨ Features" >> RELEASE_NOTES.md
        FEATURES=$(git log $COMMIT_RANGE --grep="^feat:" --pretty=format:"- %s (%h)" | grep -v "^- release" | head -10 || true)
        if [[ -n "$FEATURES" ]]; then
          echo "$FEATURES" >> RELEASE_NOTES.md
        else
          echo "_No new features_" >> RELEASE_NOTES.md
        fi
        echo "" >> RELEASE_NOTES.md

        # Bug Fixes (exclude release commits)
        echo "### ðŸ› Bug Fixes" >> RELEASE_NOTES.md
        FIXES=$(git log $COMMIT_RANGE --grep="^fix:" --pretty=format:"- %s (%h)" | grep -v "^- release" | head -10 || true)
        if [[ -n "$FIXES" ]]; then
          echo "$FIXES" >> RELEASE_NOTES.md
        else
          echo "_No bug fixes_" >> RELEASE_NOTES.md
        fi
        echo "" >> RELEASE_NOTES.md

        # Other Changes (exclude internal/maintenance commits)
        echo "### ðŸ”§ Other Changes" >> RELEASE_NOTES.md
        OTHER=$(git log $COMMIT_RANGE --invert-grep --grep="^feat:" --grep="^fix:" --grep="^release:" --grep="!" --grep="^chore:" --grep="^docs:" --grep="^style:" --grep="^refactor:" --grep="^test:" --grep="^ci:" --pretty=format:"- %s (%h)" | head -5)
        if [[ -n "$OTHER" ]]; then
          echo "$OTHER" >> RELEASE_NOTES.md
        else
          echo "_No other changes_" >> RELEASE_NOTES.md
        fi
        echo "" >> RELEASE_NOTES.md

        # Installation
        echo "## ðŸ“¦ Installation" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo '```bash' >> RELEASE_NOTES.md
        echo "${{ inputs.package-name }}@$VERSION" >> RELEASE_NOTES.md
        if [ "${{ inputs.package-manager }}" = "yarn" ]; then
          echo "yarn add ${{ inputs.package-name }}@$VERSION" >> RELEASE_NOTES.md
        else
          echo "npm install ${{ inputs.package-name }}@$VERSION" >> RELEASE_NOTES.md
        fi
        echo '```' >> RELEASE_NOTES.md

        # Output the release notes content for use in other steps
        RELEASE_NOTES=$(cat RELEASE_NOTES.md)
        echo "release-notes<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
