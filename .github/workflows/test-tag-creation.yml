name: ðŸ§ª Test Tag Creation Methods

on:
  workflow_call:
    inputs:
      package_name:
        description: "Package name for testing"
        required: true
        type: string
      test_tag_name:
        description: "Tag name to create for testing (e.g., test-v1.0.0)"
        required: true
        type: string
      target_commit:
        description: "Commit SHA to tag (defaults to HEAD)"
        required: false
        type: string
        default: ""
      cleanup_tag:
        description: "Whether to clean up the test tag after testing"
        required: false
        type: boolean
        default: true

jobs:
  # Matrix Test 1: App Token + No App Permissions + No YAML Permissions
  test-app-no-app-perms-no-yaml-perms:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.test-tags.outputs.overall_result }}
      git_result: ${{ steps.test-tags.outputs.git_result }}
      api_result: ${{ steps.test-tags.outputs.api_result }}
      gpg_result: ${{ steps.test-tags.outputs.gpg_result }}
      details: ${{ steps.test-tags.outputs.details }}

    steps:
      - uses: actions/checkout@v4

      - name: Get CLDMV app token (no permissions)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLDMV_APP_ID }}
          private-key: ${{ secrets.CLDMV_APP_PRIVATE_KEY }}
          # No repositories or permissions specified

      - name: Get user ID for bot email
        id: get-user-id
        run: |
          user_id=$(gh api user --jq '.id')
          echo "user-id=$user_id" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Test tag creation
        id: test-tags
        uses: CLDMV/.github/.github/actions/testing/steps/test-tag-creation-methods@v1
        with:
          test_name: "app-no-app-perms-no-yaml-perms"
          package_name: ${{ inputs.package_name }}
          tag_name: "a00-${{ inputs.test_tag_name }}"
          target_commit: ${{ inputs.target_commit }}
          cleanup_tag: ${{ inputs.cleanup_tag }}
          github_token: ${{ steps.app-token.outputs.token }}
          gpg_private_key: ${{ secrets.CLDMV_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.CLDMV_GPG_PASSPHRASE }}
          tagger_name: ${{ steps.app-token.outputs.app-slug && format('{0}[bot]', steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_NAME }}
          tagger_email: ${{ steps.app-token.outputs.app-slug && format('{0}+{1}[bot]@users.noreply.github.com', steps.get-user-id.outputs.user-id, steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_EMAIL }}

  # Matrix Test 2: App Token + App Permissions + No YAML Permissions
  test-app-with-app-perms-no-yaml-perms:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.test-tags.outputs.overall_result }}
      git_result: ${{ steps.test-tags.outputs.git_result }}
      api_result: ${{ steps.test-tags.outputs.api_result }}
      gpg_result: ${{ steps.test-tags.outputs.gpg_result }}
      details: ${{ steps.test-tags.outputs.details }}

    steps:
      - uses: actions/checkout@v4

      - name: Get CLDMV app token (with permissions)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLDMV_APP_ID }}
          private-key: ${{ secrets.CLDMV_APP_PRIVATE_KEY }}
          repositories: ${{ github.repository }}

      - name: Get user ID for bot email
        id: get-user-id
        run: |
          user_id=$(gh api user --jq '.id')
          echo "user-id=$user_id" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Test tag creation
        id: test-tags
        uses: CLDMV/.github/.github/actions/testing/steps/test-tag-creation-methods@v1
        with:
          test_name: "app-with-app-perms-no-yaml-perms"
          package_name: ${{ inputs.package_name }}
          tag_name: "a10-${{ inputs.test_tag_name }}"
          target_commit: ${{ inputs.target_commit }}
          cleanup_tag: ${{ inputs.cleanup_tag }}
          github_token: ${{ steps.app-token.outputs.token }}
          gpg_private_key: ${{ secrets.CLDMV_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.CLDMV_GPG_PASSPHRASE }}
          tagger_name: ${{ steps.app-token.outputs.app-slug && format('{0}[bot]', steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_NAME }}
          tagger_email: ${{ steps.app-token.outputs.app-slug && format('{0}+{1}[bot]@users.noreply.github.com', steps.get-user-id.outputs.user-id, steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_EMAIL }}

  # Matrix Test 3: App Token + No App Permissions + YAML Permissions
  test-app-no-app-perms-with-yaml-perms:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      pull-requests: write
    outputs:
      result: ${{ steps.test-tags.outputs.overall_result }}
      git_result: ${{ steps.test-tags.outputs.git_result }}
      api_result: ${{ steps.test-tags.outputs.api_result }}
      gpg_result: ${{ steps.test-tags.outputs.gpg_result }}
      details: ${{ steps.test-tags.outputs.details }}

    steps:
      - uses: actions/checkout@v4

      - name: Get CLDMV app token (no app permissions)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLDMV_APP_ID }}
          private-key: ${{ secrets.CLDMV_APP_PRIVATE_KEY }}
          # No repositories or permissions specified

      - name: Get user ID for bot email
        id: get-user-id
        run: |
          user_id=$(gh api user --jq '.id')
          echo "user-id=$user_id" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Test tag creation
        id: test-tags
        uses: CLDMV/.github/.github/actions/testing/steps/test-tag-creation-methods@v1
        with:
          test_name: "app-no-app-perms-with-yaml-perms"
          package_name: ${{ inputs.package_name }}
          tag_name: "a01-${{ inputs.test_tag_name }}"
          target_commit: ${{ inputs.target_commit }}
          cleanup_tag: ${{ inputs.cleanup_tag }}
          github_token: ${{ steps.app-token.outputs.token }}
          gpg_private_key: ${{ secrets.CLDMV_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.CLDMV_GPG_PASSPHRASE }}
          tagger_name: ${{ steps.app-token.outputs.app-slug && format('{0}[bot]', steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_NAME }}
          tagger_email: ${{ steps.app-token.outputs.app-slug && format('{0}+{1}[bot]@users.noreply.github.com', steps.get-user-id.outputs.user-id, steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_EMAIL }}

  # Matrix Test 4: App Token + App Permissions + YAML Permissions
  test-app-with-app-perms-with-yaml-perms:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      pull-requests: write
    outputs:
      result: ${{ steps.test-tags.outputs.overall_result }}
      git_result: ${{ steps.test-tags.outputs.git_result }}
      api_result: ${{ steps.test-tags.outputs.api_result }}
      gpg_result: ${{ steps.test-tags.outputs.gpg_result }}
      details: ${{ steps.test-tags.outputs.details }}

    steps:
      - uses: actions/checkout@v4

      - name: Get CLDMV app token (with app permissions)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLDMV_APP_ID }}
          private-key: ${{ secrets.CLDMV_APP_PRIVATE_KEY }}
          repositories: ${{ github.repository }}

      - name: Get user ID for bot email
        id: get-user-id
        run: |
          user_id=$(gh api user --jq '.id')
          echo "user-id=$user_id" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Test tag creation
        id: test-tags
        uses: CLDMV/.github/.github/actions/testing/steps/test-tag-creation-methods@v1
        with:
          test_name: "app-with-app-perms-with-yaml-perms"
          package_name: ${{ inputs.package_name }}
          tag_name: "a11-${{ inputs.test_tag_name }}"
          target_commit: ${{ inputs.target_commit }}
          cleanup_tag: ${{ inputs.cleanup_tag }}
          github_token: ${{ steps.app-token.outputs.token }}
          gpg_private_key: ${{ secrets.CLDMV_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.CLDMV_GPG_PASSPHRASE }}
          tagger_name: ${{ steps.app-token.outputs.app-slug && format('{0}[bot]', steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_NAME }}
          tagger_email: ${{ steps.app-token.outputs.app-slug && format('{0}+{1}[bot]@users.noreply.github.com', steps.get-user-id.outputs.user-id, steps.app-token.outputs.app-slug) || secrets.CLDMV_BOT_EMAIL }}

  # Matrix Test 5: GITHUB_TOKEN + No YAML Permissions
  test-github-token-no-yaml-perms:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.test-tags.outputs.overall_result }}
      git_result: ${{ steps.test-tags.outputs.git_result }}
      api_result: ${{ steps.test-tags.outputs.api_result }}
      gpg_result: ${{ steps.test-tags.outputs.gpg_result }}
      details: ${{ steps.test-tags.outputs.details }}

    steps:
      - uses: actions/checkout@v4

      - name: Test tag creation
        id: test-tags
        uses: CLDMV/.github/.github/actions/testing/steps/test-tag-creation-methods@v1
        with:
          test_name: "github-token-no-yaml-perms"
          package_name: ${{ inputs.package_name }}
          tag_name: "gh0-${{ inputs.test_tag_name }}"
          target_commit: ${{ inputs.target_commit }}
          cleanup_tag: ${{ inputs.cleanup_tag }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          gpg_private_key: ""
          gpg_passphrase: ""
          tagger_name: "github-actions[bot]"
          tagger_email: "github-actions[bot]@users.noreply.github.com"

  # Matrix Test 6: GITHUB_TOKEN + YAML Permissions
  test-github-token-with-yaml-perms:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      pull-requests: write
    outputs:
      result: ${{ steps.test-tags.outputs.overall_result }}
      git_result: ${{ steps.test-tags.outputs.git_result }}
      api_result: ${{ steps.test-tags.outputs.api_result }}
      gpg_result: ${{ steps.test-tags.outputs.gpg_result }}
      details: ${{ steps.test-tags.outputs.details }}

    steps:
      - uses: actions/checkout@v4

      - name: Test tag creation
        id: test-tags
        uses: CLDMV/.github/.github/actions/testing/steps/test-tag-creation-methods@v1
        with:
          test_name: "github-token-with-yaml-perms"
          package_name: ${{ inputs.package_name }}
          tag_name: "gh1-${{ inputs.test_tag_name }}"
          target_commit: ${{ inputs.target_commit }}
          cleanup_tag: ${{ inputs.cleanup_tag }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          gpg_private_key: ""
          gpg_passphrase: ""
          tagger_name: "github-actions[bot]"
          tagger_email: "github-actions[bot]@users.noreply.github.com"

  # Summary job to display comprehensive results
  summary:
    name: "ðŸ“Š Test Results Summary"
    needs:
      [
        test-app-no-app-perms-no-yaml-perms,
        test-app-with-app-perms-no-yaml-perms,
        test-app-no-app-perms-with-yaml-perms,
        test-app-with-app-perms-with-yaml-perms,
        test-github-token-no-yaml-perms,
        test-github-token-with-yaml-perms
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Display comprehensive test summary
        run: |
          echo "## ðŸ§ª Permission Matrix Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package: ${{ inputs.package_name }}" >> $GITHUB_STEP_SUMMARY
          echo "### Test Tag Base: ${{ inputs.test_tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Test Scenario | Token | App Perms | YAML Perms | Git | API | GPG | Overall |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|-----------|------------|-----|-----|-----|---------|" >> $GITHUB_STEP_SUMMARY

          # App Token + No App Perms + No YAML Perms
          a00_git="${{ needs.test-app-no-app-perms-no-yaml-perms.outputs.git_result == 'success' && 'âœ…' || 'âŒ' }}"
          a00_api="${{ needs.test-app-no-app-perms-no-yaml-perms.outputs.api_result == 'success' && 'âœ…' || 'âŒ' }}"
          a00_gpg="${{ needs.test-app-no-app-perms-no-yaml-perms.outputs.gpg_result == 'success' && 'âœ…' || 'âŒ' }}"
          a00_overall="${{ needs.test-app-no-app-perms-no-yaml-perms.outputs.result == 'success' && 'âœ…' || 'âŒ' }}"
          echo "| App + No App + No YAML | App | âŒ | âŒ | $a00_git | $a00_api | $a00_gpg | $a00_overall |" >> $GITHUB_STEP_SUMMARY

          # App Token + App Perms + No YAML Perms
          a10_git="${{ needs.test-app-with-app-perms-no-yaml-perms.outputs.git_result == 'success' && 'âœ…' || 'âŒ' }}"
          a10_api="${{ needs.test-app-with-app-perms-no-yaml-perms.outputs.api_result == 'success' && 'âœ…' || 'âŒ' }}"
          a10_gpg="${{ needs.test-app-with-app-perms-no-yaml-perms.outputs.gpg_result == 'success' && 'âœ…' || 'âŒ' }}"
          a10_overall="${{ needs.test-app-with-app-perms-no-yaml-perms.outputs.result == 'success' && 'âœ…' || 'âŒ' }}"
          echo "| App + App Perms + No YAML | App | âœ… | âŒ | $a10_git | $a10_api | $a10_gpg | $a10_overall |" >> $GITHUB_STEP_SUMMARY

          # App Token + No App Perms + YAML Perms
          a01_git="${{ needs.test-app-no-app-perms-with-yaml-perms.outputs.git_result == 'success' && 'âœ…' || 'âŒ' }}"
          a01_api="${{ needs.test-app-no-app-perms-with-yaml-perms.outputs.api_result == 'success' && 'âœ…' || 'âŒ' }}"
          a01_gpg="${{ needs.test-app-no-app-perms-with-yaml-perms.outputs.gpg_result == 'success' && 'âœ…' || 'âŒ' }}"
          a01_overall="${{ needs.test-app-no-app-perms-with-yaml-perms.outputs.result == 'success' && 'âœ…' || 'âŒ' }}"
          echo "| App + No App + YAML Perms | App | âŒ | âœ… | $a01_git | $a01_api | $a01_gpg | $a01_overall |" >> $GITHUB_STEP_SUMMARY

          # App Token + App Perms + YAML Perms
          a11_git="${{ needs.test-app-with-app-perms-with-yaml-perms.outputs.git_result == 'success' && 'âœ…' || 'âŒ' }}"
          a11_api="${{ needs.test-app-with-app-perms-with-yaml-perms.outputs.api_result == 'success' && 'âœ…' || 'âŒ' }}"
          a11_gpg="${{ needs.test-app-with-app-perms-with-yaml-perms.outputs.gpg_result == 'success' && 'âœ…' || 'âŒ' }}"
          a11_overall="${{ needs.test-app-with-app-perms-with-yaml-perms.outputs.result == 'success' && 'âœ…' || 'âŒ' }}"
          echo "| App + App Perms + YAML Perms | App | âœ… | âœ… | $a11_git | $a11_api | $a11_gpg | $a11_overall |" >> $GITHUB_STEP_SUMMARY

          # GITHUB_TOKEN + No YAML Perms  
          gh0_git="${{ needs.test-github-token-no-yaml-perms.outputs.git_result == 'success' && 'âœ…' || 'âŒ' }}"
          gh0_api="${{ needs.test-github-token-no-yaml-perms.outputs.api_result == 'success' && 'âœ…' || 'âŒ' }}"
          gh0_gpg="${{ needs.test-github-token-no-yaml-perms.outputs.gpg_result == 'success' && 'âœ…' || 'âŒ' }}"
          gh0_overall="${{ needs.test-github-token-no-yaml-perms.outputs.result == 'success' && 'âœ…' || 'âŒ' }}"
          echo "| GitHub + No YAML | GitHub | N/A | âŒ | $gh0_git | $gh0_api | $gh0_gpg | $gh0_overall |" >> $GITHUB_STEP_SUMMARY

          # GITHUB_TOKEN + YAML Perms
          gh1_git="${{ needs.test-github-token-with-yaml-perms.outputs.git_result == 'success' && 'âœ…' || 'âŒ' }}"
          gh1_api="${{ needs.test-github-token-with-yaml-perms.outputs.api_result == 'success' && 'âœ…' || 'âŒ' }}"
          gh1_gpg="${{ needs.test-github-token-with-yaml-perms.outputs.gpg_result == 'success' && 'âœ…' || 'âŒ' }}"
          gh1_overall="${{ needs.test-github-token-with-yaml-perms.outputs.result == 'success' && 'âœ…' || 'âŒ' }}"
          echo "| GitHub + YAML Perms | GitHub | N/A | âœ… | $gh1_git | $gh1_api | $gh1_gpg | $gh1_overall |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Matrix Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Token**: App (GitHub App) vs GitHub (GITHUB_TOKEN)" >> $GITHUB_STEP_SUMMARY
          echo "- **App Perms**: Whether app token has explicit repository permissions" >> $GITHUB_STEP_SUMMARY
          echo "- **YAML Perms**: Whether workflow has explicit \`permissions:\` block" >> $GITHUB_STEP_SUMMARY
          echo "- **Git**: Tests \`git push --tags\` with authentication" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: Tests GitHub API tag creation" >> $GITHUB_STEP_SUMMARY
          echo "- **GPG**: Tests GPG signature verification" >> $GITHUB_STEP_SUMMARY
          echo "- **Overall**: Combined result of all tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Key Findings" >> $GITHUB_STEP_SUMMARY
          echo "This matrix helps identify:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Permission interaction bugs** between app and workflow permissions" >> $GITHUB_STEP_SUMMARY
          echo "2. **Token type differences** in authentication behavior" >> $GITHUB_STEP_SUMMARY
          echo "3. **API vs Git command consistency** across permission combinations" >> $GITHUB_STEP_SUMMARY
          echo "4. **GPG signing compatibility** with different permission setups" >> $GITHUB_STEP_SUMMARY
