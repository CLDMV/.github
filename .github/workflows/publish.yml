# CLDMV/.github/.github/workflows/publish.yml
name: Publish Workflow (Org-Level)

on:
  workflow_call:
    inputs:
      package_name:
        required: true
        type: string
        description: "NPM package name (e.g., @cldmv/slothlet)"
      node_version:
        required: false
        type: string
        default: "lts/*"
        description: "Node.js version to use (default: lts/*)"
      package_manager:
        required: false
        type: string
        default: "npm"
        description: "Package manager (npm or yarn)"
      version:
        required: false
        type: string
        default: ""
        description: "Version to publish (auto-detected from package.json if not provided)"
      publish_to_npm:
        required: false
        type: boolean
        default: true
        description: "Publish to NPM registry"
      publish_to_github_packages:
        required: false
        type: boolean
        default: true
        description: "Publish to GitHub Packages registry"
      publish_command:
        required: false
        type: string
        default: ""
        description: "Custom NPM publish command"
      github_packages_publish_command:
        required: false
        type: string
        default: ""
        description: "Custom GitHub Packages publish command"
      skip_publish:
        required: false
        type: boolean
        default: false
        description: "Skip ALL publishing (for testing)"
      # Build parameters
      min_node_version:
        required: false
        type: string
        default: "20"
        description: "Minimum Node.js version for matrix testing (enables matrix when set)"
      max_node_major:
        required: false
        type: string
        default: "22"
        description: "Override max Node.js major version (default: 22)"
      test_command:
        required: false
        type: string
        default: "npm test"
        description: "Command to run tests"
      build_command:
        required: false
        type: string
        default: "npm run build:ci"
        description: "Command to build package"
      # Release parameters
      is_prerelease:
        required: false
        type: boolean
        default: false
        description: "Whether this is a prerelease"
      release_source_only:
        required: false
        type: boolean
        default: false
        description: "Whether to create source-only release (no package assets)"
      create_documentation:
        required: false
        type: boolean
        default: true
        description: "Whether to create/update VERSION_TAGS.md"
      # Test control options
      skip_performance_tests:
        required: false
        type: boolean
        default: false
        description: "Skip performance tests during CI"
      skip_matrix_tests:
        required: false
        type: boolean
        default: false
        description: "Skip matrix testing (use single node version only)"

    secrets:
      NPM_TOKEN:
        description: "NPM token for publishing packages"
        required: true

    outputs:
      npm-published:
        description: "Whether the package was published to NPM"
        value: ${{ jobs.publish.outputs.npm-published }}
      github-packages-published:
        description: "Whether the package was published to GitHub Packages"
        value: ${{ jobs.publish.outputs.github-packages-published }}
      release-id:
        description: "The ID of the created GitHub release"
        value: ${{ jobs.publish.outputs.release-id }}
      major-version:
        description: "The major version tag that was updated"
        value: ${{ jobs.publish.outputs.major-version }}
      tags-updated:
        description: "Whether version tags were updated"
        value: ${{ jobs.publish.outputs.tags-updated }}

jobs:
  debug-inputs:
    name: "ðŸ” Debug Input Parameters"
    runs-on: ubuntu-latest
    steps:
      - name: "Debug min_node_version parameter"
        run: |
          echo "ðŸ” DEBUG (publish.yml): min_node_version input = '${{ inputs.min_node_version }}'"
          echo "ðŸ” DEBUG (publish.yml): max_node_major input = '${{ inputs.max_node_major }}'"
          echo "ðŸ” DEBUG (publish.yml): node_version input = '${{ inputs.node_version }}'"

  publish:
    name: "ðŸ“¦ Publish Package"
    needs: debug-inputs
    uses: ./.github/workflows/ci-jobs.yml
    with:
      package_name: ${{ inputs.package_name }}
      run_build_and_test: true
      run_detect_repo_config: true
      run_download_artifacts: true
      run_publish_npm: ${{ inputs.publish_to_npm && !inputs.skip_publish }}
      run_publish_github_packages: ${{ inputs.publish_to_github_packages && !inputs.skip_publish }}
      run_create_release: true
      run_update_major_version_tags: true
      node_version: ${{ inputs.node_version }}
      min_node_version: ${{ inputs.min_node_version }}
      max_node_major: ${{ inputs.max_node_major }}
      package_manager: ${{ inputs.package_manager }}
      test_command: ${{ inputs.test_command }}
      build_command: ${{ inputs.build_command }}
      version: ${{ inputs.version }}
      is_prerelease: ${{ inputs.is_prerelease }}
      release_source_only: ${{ inputs.release_source_only }}
      create_documentation: ${{ inputs.create_documentation }}
      publish_command_npm: ${{ inputs.publish_command }}
      publish_command_github_packages: ${{ inputs.github_packages_publish_command }}
      skip_performance_tests: ${{ inputs.skip_performance_tests }}
      skip_matrix_tests: ${{ inputs.skip_matrix_tests }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  summary:
    name: "ðŸ“‹ Publish Summary"
    needs: publish
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Publish Summary
        run: |
          echo "## ðŸ“¦ Publish Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package**: \`${{ inputs.package_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.publish.result }}" = "success" ]; then
            echo "âœ… **Status**: Package publishing completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”„ **Publishing Results**:" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ inputs.publish_to_npm }}" = "true" ] && [ "${{ inputs.skip_publish }}" != "true" ]; then
              if [ "${{ needs.publish.outputs.npm-published }}" = "true" ]; then
                echo "- âœ… NPM Registry: Published successfully" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âŒ NPM Registry: Publishing failed or skipped" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- â­ï¸ NPM Registry: Skipped (disabled or skip_publish=true)" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ inputs.publish_to_github_packages }}" = "true" ] && [ "${{ inputs.skip_publish }}" != "true" ]; then
              if [ "${{ needs.publish.outputs.github-packages-published }}" = "true" ]; then
                echo "- âœ… GitHub Packages: Published successfully" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âŒ GitHub Packages: Publishing failed or skipped" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- â­ï¸ GitHub Packages: Skipped (disabled or skip_publish=true)" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.publish.outputs.release-id }}" != "" ]; then
              echo "- âœ… GitHub Release: Created (ID: ${{ needs.publish.outputs.release-id }})" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.publish.outputs.tags-updated }}" = "true" ]; then
              echo "- âœ… Version Tags: Updated to v${{ needs.publish.outputs.major-version }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Status**: Package publishing failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details. Common issues:" >> $GITHUB_STEP_SUMMARY
            echo "- Build or test failures" >> $GITHUB_STEP_SUMMARY
            echo "- Authentication failures (check NPM_TOKEN)" >> $GITHUB_STEP_SUMMARY
            echo "- Version conflicts (version may already exist)" >> $GITHUB_STEP_SUMMARY
            echo "- Registry permissions or network issues" >> $GITHUB_STEP_SUMMARY
          fi
