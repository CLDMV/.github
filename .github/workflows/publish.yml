# CLDMV/.github/.github/workflows/publish.yml
name: Publish Workflow (Org-Level)

on:
  workflow_call:
    inputs:
      package_name:
        required: true
        type: string
        description: "NPM package name (e.g., @cldmv/slothlet)"
      node_version:
        required: false
        type: string
        default: "lts/*"
        description: "Node.js version to use"
      package_manager:
        required: false
        type: string
        default: "npm"
        description: "Package manager (npm or yarn)"
      version:
        required: true
        type: string
        description: "Version to publish"
      publish_to_npm:
        required: false
        type: boolean
        default: true
        description: "Publish to NPM registry"
      publish_to_github_packages:
        required: false
        type: boolean
        default: true
        description: "Publish to GitHub Packages registry"
      publish_command:
        required: false
        type: string
        default: ""
        description: "Custom NPM publish command"
      github_packages_publish_command:
        required: false
        type: string
        default: ""
        description: "Custom GitHub Packages publish command"
      skip_publish:
        required: false
        type: boolean
        default: false
        description: "Skip ALL publishing (for testing)"

    secrets:
      NPM_TOKEN:
        description: "NPM token for publishing packages"
        required: true

    outputs:
      published:
        description: "Whether the package was successfully published"
        value: ${{ jobs.publish.outputs.published }}
      npm-published:
        description: "Whether the package was published to NPM"
        value: ${{ jobs.publish.outputs.npm-published }}
      github-packages-published:
        description: "Whether the package was published to GitHub Packages"
        value: ${{ jobs.publish.outputs.github-packages-published }}

jobs:
  publish:
    name: "ðŸ“¦ Publish Package"
    uses: ./.github/workflows/ci-jobs.yml
    with:
      package_name: ${{ inputs.package_name }}
      run_build_and_test: true
      run_detect_repo_config: true
      run_publish_npm: ${{ inputs.publish_to_npm && !inputs.skip_publish }}
      run_publish_github_packages: ${{ inputs.publish_to_github_packages && !inputs.skip_publish }}
      run_create_release: true
      run_update_major_version_tags: true
      node_version: ${{ inputs.node_version }}
      package_manager: ${{ inputs.package_manager }}
      version: ${{ inputs.version }}
      publish_command_npm: ${{ inputs.publish_command }}
      publish_command_github_packages: ${{ inputs.github_packages_publish_command }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
