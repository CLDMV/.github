# .github/workflows/update-major-version-tags.yml
name: ðŸ“Œ Update Major Version Tags (Org-Level)

on:
  workflow_call:
    inputs:
      create_documentation:
        description: "Whether to create/update VERSION_TAGS.md documentation"
        required: false
        type: boolean
        default: true
      sign:
        description: "Smart signing mode (auto/true/false)"
        required: false
        type: string
        default: "auto"
      annotate:
        description: "Smart annotate mode (auto/true/false)"
        required: false
        type: string
        default: "auto"
      use_gpg:
        description: "If true, forward provided secrets to enable signing"
        required: false
        type: boolean
        default: false
    secrets:
      TAGGER_NAME:
        required: false
      TAGGER_EMAIL:
        required: false
      GPG_PRIVATE_KEY:
        required: false
      GPG_PASSPHRASE:
        required: false
      BOT_APP_ID:
        required: false
      BOT_APP_PRIVATE_KEY:
        required: false

permissions:
  contents: write

jobs:
  update:
    name: Update major/minor version tags
    runs-on: ubuntu-latest
    outputs:
      major-version: ${{ steps.tags.outputs.major-version }}
      minor-version: ${{ steps.tags.outputs.minor-version }}
      updated: ${{ steps.tags.outputs.updated }}
      has-version-tags: ${{ steps.tags.outputs.has-version-tags }}
      should-run: ${{ steps.tags.outputs.should-run }}
      fixed-orphans: ${{ steps.tags.outputs.fixed-orphans }}
      orphans-found: ${{ steps.tags.outputs.orphans-found }}
      fixed-bot-signatures: ${{ steps.fix-bot-signatures.outputs.fixed-tags }}
      non-bot-tags-found: ${{ steps.fix-bot-signatures.outputs.non-bot-tags-found }}
    steps:
      - name: Create App token (auto-detect)
        id: app-token
        uses: CLDMV/.github/.github/actions/github/steps/create-app-token@v1
        env:
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_APP_PRIVATE_KEY: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Fix non-bot-signed version tags
        id: fix-bot-signatures
        uses: CLDMV/.github/.github/actions/git/jobs/fix-non-bot-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          sign: ${{ inputs.sign }}
          annotate: ${{ inputs.annotate }}
          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}

      - name: Check for version tags and update
        id: tags
        uses: CLDMV/.github/.github/actions/git/jobs/update-major-version-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          create-documentation: ${{ inputs.create_documentation }}
          sign: ${{ inputs.sign }}
          annotate: ${{ inputs.annotate }}

          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}
