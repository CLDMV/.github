# CLDMV/.github/.github/workflows/ci-jobs.yml
name: âš™ï¸ CI Jobs Workflow (Internal Org-Level)

on:
  workflow_call:
    inputs:
      debug:
        description: "Enable debug logging for troubleshooting"
        required: false
        type: boolean
        default: false
      run_download_artifacts:
        description: "Run download artifacts job"
        required: false
        type: boolean
        default: false
      download_artifact_name:
        description: "Name of the artifact to download (e.g., build-artifacts-lts). Defaults to build-artifacts-lts or build-artifacts-{node_version}."
        required: false
        type: string
        default: ${{ inputs.node_version && format('build-artifacts-{0}', inputs.node_version == 'lts/*' && 'lts' || inputs.node_version) || 'build-artifacts-lts' }}
      download_artifact_path:
        description: "Destination path for the downloaded artifact(s)"
        required: false
        type: string
        default: "."
      # Package information
      package_name:
        description: "NPM package name (e.g., @cldmv/slothlet)"
        required: true
        type: string

      # Job control flags - all default to false
      run_build_and_test:
        description: "Run build and test job"
        required: false
        type: boolean
        default: false
      run_create_release_pr:
        description: "Run create release PR job"
        required: false
        type: boolean
        default: false
      run_create_release:
        description: "Run create GitHub release job"
        required: false
        type: boolean
        default: false
      run_detect_release:
        description: "Run detect release job"
        required: false
        type: boolean
        default: false
      run_update_major_version_tags:
        description: "Run update major version tags job"
        required: false
        type: boolean
        default: false
      run_fix_bot_signatures:
        description: "Run fix non-bot-signed version tags job"
        required: false
        type: boolean
        default: false
      run_unified_tag_health:
        description: "Run unified tag health check (replaces run_fix_bot_signatures + run_update_version_tags)"
        required: false
        type: boolean
        default: false
      run_update_version_tags:
        description: "Run update major/minor version tags job"
        required: false
        type: boolean
        default: false
      run_publish_npm:
        description: "Run publish to NPM job"
        required: false
        type: boolean
        default: false
      run_publish_github_packages:
        description: "Run publish to GitHub Packages job"
        required: false
        type: boolean
        default: false
      run_detect_repo_config:
        description: "Run detect repository config job"
        required: false
        type: boolean
        default: false

      # Build and test parameters
      node_version:
        description: "Node.js version to use (default: lts/*)"
        required: false
        type: string
        default: "lts/*"
      min_node_version:
        description: "Minimum Node.js version to test (e.g., 16.4)"
        required: false
        type: string
        default: "20"
      max_node_major:
        description: "Override max Node.js major version (default: 22)"
        required: false
        type: string
        default: "22"
      package_manager:
        description: "Package manager (npm or yarn)"
        required: false
        type: string
        default: "npm"
      test_command:
        description: "Command to run tests"
        required: false
        type: string
        default: "npm test"
      build_command:
        description: "Command to build package"
        required: false
        type: string
        default: "npm run build:ci"
      # Test control options
      skip_performance_tests:
        description: "Skip performance tests during CI"
        required: false
        type: boolean
        default: false
      skip_matrix_tests:
        description: "Skip matrix testing (use single node version only)"
        required: false
        type: boolean
        default: false

      # Release parameters
      version_bump:
        description: "Type of version bump (major, minor, patch). Leave empty for auto-detection from commit message."
        required: false
        type: string
        default: ""
      version:
        description: "Specific version for release"
        required: false
        type: string
        default: ""
      is_prerelease:
        description: "Whether this is a prerelease"
        required: false
        type: boolean
        default: false
      release_source_only:
        description: "Whether to create source-only release (no package assets)"
        required: false
        type: boolean
        default: false

      # Publishing parameters
      publish_command_npm:
        description: "Command to publish to NPM"
        required: false
        type: string
        default: ""
      publish_command_github_packages:
        description: "Command to publish to GitHub Packages"
        required: false
        type: string
        default: ""

      # Documentation parameters
      create_documentation:
        description: "Whether to create/update VERSION_TAGS.md"
        required: false
        type: boolean
        default: true

      # Version tag parameters
      sign:
        description: "Smart signing mode (auto/true/false)"
        required: false
        type: string
        default: "auto"
      annotate:
        description: "Smart annotate mode (auto/true/false)"
        required: false
        type: string
        default: "auto"
      use_gpg:
        description: "If true, forward provided secrets to enable signing"
        required: false
        type: boolean
        default: false

      # Tag health configuration
      max_tags:
        description: "Maximum number of tags to process (safety limit)"
        required: false
        type: string
        default: "100"
      max_major_versions:
        description: "Maximum number of major versions to process"
        required: false
        type: string
        default: "10"
      max_minor_versions:
        description: "Maximum number of minor versions per major to process"
        required: false
        type: string
        default: "10"
      bot_patterns:
        description: "JSON array of bot name patterns to identify bot signatures"
        required: false
        type: string
        default: '["CLDMV Bot", "cldmv-bot", "github-actions[bot]"]'
      include_patterns:
        description: "JSON array of tag patterns to include (e.g. ['v*', 'release-*'])"
        required: false
        type: string
        default: '["v*"]'
      exclude_patterns:
        description: "JSON array of tag patterns to exclude"
        required: false
        type: string
        default: "[]"

    secrets:
      NPM_TOKEN:
        description: "NPM token for publishing packages"
        required: false
      BOT_APP_ID:
        description: "GitHub App ID for CLDMV bot"
        required: false
      BOT_APP_PRIVATE_KEY:
        description: "GitHub App private key for CLDMV bot"
        required: false
      TAGGER_NAME:
        description: "GPG tagger name for signing"
        required: false
      TAGGER_EMAIL:
        description: "GPG tagger email for signing"
        required: false
      GPG_PRIVATE_KEY:
        description: "ASCII-armored private key for signing"
        required: false
      GPG_PASSPHRASE:
        description: "Passphrase for the private key (if protected)"
        required: false

    outputs:
      # Release management outputs
      pr-created:
        description: "Whether a release PR was created"
        value: ${{ jobs.create-release-pr.outputs.pr-created }}
      pr-number:
        description: "The number of the created release PR"
        value: ${{ jobs.create-release-pr.outputs.pr-number }}
      new-version:
        description: "The new version that will be released"
        value: ${{ jobs.create-release-pr.outputs.new-version }}

      # Release detection outputs
      should-release:
        description: "Whether this commit should trigger a release"
        value: ${{ jobs.detect-release.outputs.should-release }}

      # GitHub release outputs
      release-id:
        description: "The ID of the created GitHub release"
        value: ${{ jobs.create-release.outputs.release-id }}

      # Publishing outputs
      npm-published:
        description: "Whether the package was published to NPM"
        value: ${{ jobs.publish-npm.outputs.published }}
      github-packages-published:
        description: "Whether the package was published to GitHub Packages"
        value: ${{ jobs.publish-github-packages.outputs.published }}

      # Version tag outputs
      major-version:
        description: "The major version tag that was updated"
        value: ${{ jobs.update-version-tags.outputs.major-version }}
      minor-version:
        description: "The minor version tag that was updated"
        value: ${{ jobs.update-version-tags.outputs.minor-version }}
      tags-updated:
        description: "Whether version tags were updated"
        value: ${{ jobs.update-version-tags.outputs.updated }}
      has-version-tags:
        description: "Whether the repository has version tags"
        value: ${{ jobs.update-version-tags.outputs.has-version-tags }}
      should-run:
        description: "Whether tag updates should run"
        value: ${{ jobs.update-version-tags.outputs.should-run }}
      fixed-orphans:
        description: "Orphaned tags that were fixed"
        value: ${{ jobs.update-version-tags.outputs.fixed-orphans }}
      orphans-found:
        description: "Whether orphaned tags were found"
        value: ${{ jobs.update-version-tags.outputs.orphans-found }}
      fixed-bot-signatures:
        description: "Non-bot tags that were fixed"
        value: ${{ jobs.fix-bot-signatures.outputs.fixed-tags }}
      non-bot-tags-found:
        description: "Whether non-bot tags were found"
        value: ${{ jobs.fix-bot-signatures.outputs.non-bot-tags-found }}

jobs:
  set-matrix:
    name: "Set Node.js Matrix"
    runs-on: ubuntu-latest
    if: inputs.run_build_and_test == true
    outputs:
      node-matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # Check if matrix testing is skipped
          if [[ "${{ inputs.skip_matrix_tests }}" == "true" ]]; then
            # Use single node version
            SINGLE_VERSION="${{ inputs.node_version }}"
            echo "ðŸ“ Matrix testing skipped, using single version: $SINGLE_VERSION"
            echo "matrix=[\"$SINGLE_VERSION\"]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build matrix from min to max versions
          MIN="${{ inputs.min_node_version }}"
          MAX_INPUT="${{ inputs.max_node_major }}"
          DEFAULT_MAX=22

          echo "ðŸ” DEBUG (ci-jobs.yml): min_node_version = '$MIN'"
          echo "ðŸ” DEBUG (ci-jobs.yml): max_node_major = '$MAX_INPUT'"

          if [[ -n "$MAX_INPUT" ]]; then
            MAX=$MAX_INPUT
          else
            MAX=$DEFAULT_MAX
          fi

          # Parse major and minor from min version
          MAJOR=$(echo $MIN | cut -d. -f1)
          MINOR=$(echo $MIN | cut -d. -f2)

          # Build versions array
          VERSIONS=()
          if [[ "$MIN" == *"."* ]]; then
            VERSIONS+=("\"${MAJOR}.${MINOR}\"")
            ((MAJOR++))
          fi
          while [ $MAJOR -le $MAX ]; do
            VERSIONS+=("\"${MAJOR}\"")
            ((MAJOR++))
          done
          VERSIONS+=("\"lts/*\"")

          # Join with commas and create JSON array
          printf -v joined '%s,' "${VERSIONS[@]}"
          joined="[${joined%,}]"
          echo "ðŸ“Š Matrix testing enabled with versions: $joined"
          echo "matrix=$joined" >> $GITHUB_OUTPUT

  build-and-test:
    name: "ðŸ—ï¸ Build & Test"
    if: inputs.run_build_and_test == true
    runs-on: ubuntu-latest
    needs: set-matrix
    strategy:
      matrix:
        node-version: ${{ fromJson(needs.set-matrix.outputs.node-matrix) }}
    steps:
      - name: Build and Test
        uses: CLDMV/.github/.github/actions/npm/jobs/build-and-test@v1
        with:
          node-version: ${{ matrix.node-version }}
          package-manager: ${{ inputs.package_manager }}
          test-command: ${{ inputs.test_command }}
          build-command: ${{ inputs.build_command }}
          skip-performance-tests: ${{ inputs.skip_performance_tests }}

  detect-release:
    name: "ðŸ” Detect Release"
    if: inputs.run_detect_release == true
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.detect.outputs.should-release }}
      version: ${{ steps.detect.outputs.version }}
      is-prerelease: ${{ steps.detect.outputs.is-prerelease }}
    steps:
      - name: Detect Release
        id: detect
        uses: CLDMV/.github/.github/actions/git/jobs/detect-release@v1

  create-release-pr:
    name: "ðŸ“‹ Create Release PR"
    if: inputs.run_create_release_pr == true
    runs-on: ubuntu-latest
    outputs:
      pr-created: ${{ steps.create.outputs.pr-created }}
      pr-number: ${{ steps.create.outputs.pr-number }}
      new-version: ${{ steps.create.outputs.new-version }}
    steps:
      - name: Create App token (auto-detect)
        id: app-token
        uses: CLDMV/.github/.github/actions/github/steps/create-app-token@v1
        with:
          app_id: ${{ secrets.BOT_APP_ID }}
          private_key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
        env:
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_APP_PRIVATE_KEY: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Create Release PR
        id: create
        uses: CLDMV/.github/.github/actions/github/jobs/create-release-pr@v1
        with:
          package-name: ${{ inputs.package_name }}
          node-version: ${{ inputs.node_version }}
          package-manager: ${{ inputs.package_manager }}
          build-command: ${{ inputs.build_command }}
          version-bump: ${{ inputs.version_bump }}
          github-token: ${{ steps.app-token.outputs.token }}
    #   - name: Dispatch CI for PR branch
    #     uses: actions/github-script@v7
    #     with:
    #       github-token: ${{ secrets.GITHUB_TOKEN }}
    #       script: |
    #         await github.actions.createWorkflowDispatch({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           workflow_id: "ci.yml",             // or the numeric ID
    #           ref: process.env.GITHUB_REF_NAME,  // PR branch name
    #           inputs: { debug: "false" }
    #         })
  download-artifacts:
    name: "â¬‡ï¸ Download Artifacts"
    if: inputs.run_download_artifacts == true
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Debug artifact name calculation
        shell: bash
        run: |
          echo "ðŸ” DEBUG: Artifact name calculation"
          echo "  node_version input: '${{ inputs.node_version }}'"
          echo "  download_artifact_name input: '${{ inputs.download_artifact_name }}'"
          echo "  Expected artifact name: ${{ inputs.download_artifact_name }}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.download_artifact_name }}
          path: ${{ inputs.download_artifact_path }}

  create-release:
    name: "ðŸ“‹ Create GitHub Release"
    if: inputs.run_create_release == true
    runs-on: ubuntu-latest
    needs: [build-and-test, detect-release]
    outputs:
      release-id: ${{ steps.create.outputs.release-id }}
    steps:
      - name: Create App token (auto-detect)
        id: app-token
        uses: CLDMV/.github/.github/actions/github/steps/create-app-token@v1
        with:
          app_id: ${{ secrets.BOT_APP_ID }}
          private_key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
        env:
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_APP_PRIVATE_KEY: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Create GitHub Release
        id: create
        uses: CLDMV/.github/.github/actions/github/jobs/create-release@v1
        with:
          version: ${{ needs.detect-release.outputs.version || inputs.version }}
          package-name: ${{ inputs.package_name }}
          is-prerelease: ${{ inputs.is_prerelease }}
          package-manager: ${{ inputs.package_manager }}
          release-source-only: ${{ inputs.release_source_only }}
          node-version: ${{ inputs.node_version }}
          build-command: ${{ inputs.build_command }}
          github-token: ${{ steps.app-token.outputs.token }}

  detect-repo-config:
    name: "ðŸ”§ Detect Repository Config"
    if: inputs.run_detect_repo_config == true
    runs-on: ubuntu-latest
    outputs:
      npm-command: ${{ steps.detect.outputs.npm-command }}
      github-packages-command: ${{ steps.detect.outputs.github-packages-command }}
      repo-is-private: ${{ steps.detect.outputs.repo-is-private }}
    steps:
      - name: Detect Repository Config
        id: detect
        uses: CLDMV/.github/.github/actions/github/jobs/detect-repo-config@v1
        with:
          package-manager: ${{ inputs.package_manager }}
          custom-npm-command: ${{ inputs.publish_command_npm }}
          custom-github-packages-command: ${{ inputs.publish_command_github_packages }}
          github-token: ${{ github.token }}

  publish-npm:
    name: "ðŸ“¦ Publish to NPM"
    if: inputs.run_publish_npm == true
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      published: ${{ steps.publish.outputs.published }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract and validate version
        id: extract-version
        uses: ./.github/actions/npm/steps/extract-version
        with:
          package-name: ${{ inputs.package_name }}
          version-override: ${{ inputs.version }}

      - name: Calculate artifact names
        id: names
        uses: CLDMV/.github/.github/actions/common/steps/calculate-names@v1
        with:
          node-version: ${{ inputs.node_version }}
          package-name: ${{ inputs.package_name }}
          version: ${{ steps.extract-version.outputs.version }}

      - name: Publish to NPM
        id: publish
        uses: CLDMV/.github/.github/actions/npm/jobs/publish-npm@v1
        with:
          package-name: ${{ inputs.package_name }}
          version: ${{ steps.extract-version.outputs.version }}
          node-version: ${{ inputs.node_version }}
          package-manager: ${{ inputs.package_manager }}
          publish-command: ${{ inputs.publish_command_npm }}
          npm-token: ${{ secrets.NPM_TOKEN }}
          artifact-name: ${{ steps.names.outputs.artifact-name }}

  publish-github-packages:
    name: "ðŸ“¦ Publish to GitHub Packages"
    if: inputs.run_publish_github_packages == true
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      published: ${{ steps.publish.outputs.published }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract and validate version
        id: extract-version
        uses: ./.github/actions/npm/steps/extract-version
        with:
          package-name: ${{ inputs.package_name }}
          version-override: ${{ inputs.version }}

      - name: Calculate artifact names
        id: names
        uses: CLDMV/.github/.github/actions/common/steps/calculate-names@v1
        with:
          node-version: ${{ inputs.node_version }}
          package-name: ${{ inputs.package_name }}
          version: ${{ steps.extract-version.outputs.version }}

      - name: Publish to GitHub Packages
        id: publish
        uses: CLDMV/.github/.github/actions/npm/jobs/publish-github-packages@v1
        with:
          package-name: ${{ inputs.package_name }}
          version: ${{ steps.extract-version.outputs.version }}
          node-version: ${{ inputs.node_version }}
          package-manager: ${{ inputs.package_manager }}
          publish-command: ${{ inputs.publish_command_github_packages }}
          github-token: ${{ github.token }}
          artifact-name: ${{ steps.names.outputs.artifact-name }}

  fix-bot-signatures:
    name: "ðŸ¤– Fix Non-Bot-Signed Version Tags"
    if: inputs.run_fix_bot_signatures == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      fixed-tags: ${{ steps.fix-bot-signatures.outputs.fixed-tags }}
      non-bot-tags-found: ${{ steps.fix-bot-signatures.outputs.non-bot-tags-found }}
    steps:
      - name: Create App token (auto-detect)
        id: app-token
        uses: CLDMV/.github/.github/actions/github/steps/create-app-token@v1
        with:
          app_id: ${{ secrets.BOT_APP_ID }}
          private_key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
        env:
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_APP_PRIVATE_KEY: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Fix non-bot-signed version tags
        id: fix-bot-signatures
        uses: CLDMV/.github/.github/actions/git/jobs/fix-non-bot-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CI_DEBUG: ${{ inputs.debug && 'true' || 'false' }}
        with:
          debug: ${{ inputs.debug }}
          sign: ${{ inputs.sign || 'auto' }}
          annotate: ${{ inputs.annotate }}
          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}

  update-version-tags:
    name: "ðŸ·ï¸ Update Major/Minor Version Tags"
    if: inputs.run_update_version_tags == true
    runs-on: ubuntu-latest
    needs: fix-bot-signatures
    permissions:
      contents: write
    outputs:
      major-version: ${{ steps.tags.outputs.major-version }}
      minor-version: ${{ steps.tags.outputs.minor-version }}
      updated: ${{ steps.tags.outputs.updated }}
      has-version-tags: ${{ steps.tags.outputs.has-version-tags }}
      should-run: ${{ steps.tags.outputs.should-run }}
      fixed-orphans: ${{ steps.tags.outputs.fixed-orphans }}
      orphans-found: ${{ steps.tags.outputs.orphans-found }}
      # Pass through outputs from first job
      fixed-bot-signatures: ${{ needs.fix-bot-signatures.outputs.fixed-tags }}
      non-bot-tags-found: ${{ needs.fix-bot-signatures.outputs.non-bot-tags-found }}
    steps:
      - name: Create App token (auto-detect)
        id: app-token
        uses: CLDMV/.github/.github/actions/github/steps/create-app-token@v1
        with:
          app_id: ${{ secrets.BOT_APP_ID }}
          private_key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
        env:
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_APP_PRIVATE_KEY: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Check for version tags and update
        id: tags
        uses: CLDMV/.github/.github/actions/git/jobs/update-major-version-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CI_DEBUG: ${{ inputs.debug && 'true' || 'false' }}
        with:
          debug: ${{ inputs.debug }}
          create-documentation: ${{ inputs.create_documentation }}
          sign: ${{ inputs.sign }}
          annotate: ${{ inputs.annotate }}

          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}

  unified-tag-health:
    name: "ðŸ·ï¸ Unified Tag Health Check"
    if: inputs.run_unified_tag_health == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      total_processed: ${{ steps.summarize.outputs.total-processed }}
      total_fixed: ${{ steps.summarize.outputs.total-fixed }}
      processing_summary: ${{ steps.summarize.outputs.processing-summary }}
      # Individual step outputs for compatibility
      fixed-bot-signatures: ${{ steps.fix-bot-sigs.outputs.fixed_count }}
      non-bot-tags-found: ${{ steps.fix-bot-sigs.outputs.fixed_count }}
      major-version: ${{ steps.update-major-tags.outputs.major-version }}
      minor-version: ${{ steps.update-major-tags.outputs.minor-version }}
      updated: ${{ steps.update-major-tags.outputs.updated }}
      has-version-tags: ${{ steps.update-major-tags.outputs.has-version-tags }}
      should-run: ${{ steps.update-major-tags.outputs.should-run }}
      fixed-orphans: ${{ steps.update-major-tags.outputs.fixed-orphans }}
      orphans-found: ${{ steps.update-major-tags.outputs.orphans-found }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create App token (auto-detect)
        id: app-token
        uses: CLDMV/.github/.github/actions/github/steps/create-app-token@v1
        with:
          app_id: ${{ secrets.BOT_APP_ID }}
          private_key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
        env:
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_APP_PRIVATE_KEY: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      # Step 1: Get detailed tag list for processing
      - name: Get tags to process
        id: get-tags
        uses: CLDMV/.github/.github/actions/git/steps/get-detailed-tags@v1
        with:
          debug: ${{ inputs.debug }}
          max_tags: ${{ inputs.max_tags }}
          max_major_versions: ${{ inputs.max_major_versions }}
          max_minor_versions: ${{ inputs.max_minor_versions }}
          bot_patterns: ${{ inputs.bot_patterns }}
          include_patterns: ${{ inputs.include_patterns }}
          exclude_patterns: ${{ inputs.exclude_patterns }}

      # Step 2: Update major/minor version tags FIRST (creates new tags if needed)
      - name: Update major/minor version tags
        id: update-major-tags
        uses: CLDMV/.github/.github/actions/git/jobs/update-major-version-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CI_DEBUG: ${{ inputs.debug && 'true' || 'false' }}
        with:
          debug: ${{ inputs.debug }}
          create-documentation: ${{ inputs.create_documentation }}
          sign: ${{ inputs.sign }}
          annotate: ${{ inputs.annotate }}
          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}

      # Step 3: Re-scan tags after major/minor updates
      - name: Re-scan tags after major/minor updates
        id: rescan-after-major
        uses: CLDMV/.github/.github/actions/git/steps/get-detailed-tags@v1
        with:
          debug: ${{ inputs.debug }}
          max_tags: ${{ inputs.max_tags }}
          max_major_versions: ${{ inputs.max_major_versions }}
          max_minor_versions: ${{ inputs.max_minor_versions }}
          bot_patterns: ${{ inputs.bot_patterns }}
          include_patterns: ${{ inputs.include_patterns }}
          exclude_patterns: ${{ inputs.exclude_patterns }}

      # Step 4: Fix non-bot signatures (using fresh tag data)
      - name: Fix non-bot signatures
        id: fix-bot-sigs
        uses: CLDMV/.github/.github/actions/git/steps/fix-non-bot-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CI_DEBUG: ${{ inputs.debug && 'true' || 'false' }}
        with:
          debug: ${{ inputs.debug }}
          tags_detailed: ${{ steps.rescan-after-major.outputs.tags_detailed }}
          sign: ${{ inputs.sign || 'auto' }}
          annotate: ${{ inputs.annotate }}
          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}

      # Step 5: Re-scan tags after bot signature fixes
      - name: Re-scan tags after bot signature fixes
        id: rescan-after-bot-sigs
        uses: CLDMV/.github/.github/actions/git/steps/get-detailed-tags@v1
        with:
          debug: ${{ inputs.debug }}
          max_tags: ${{ inputs.max_tags }}
          max_major_versions: ${{ inputs.max_major_versions }}
          max_minor_versions: ${{ inputs.max_minor_versions }}
          bot_patterns: ${{ inputs.bot_patterns }}
          include_patterns: ${{ inputs.include_patterns }}
          exclude_patterns: ${{ inputs.exclude_patterns }}

      # Step 6: Fix unsigned tags (using fresh tag data)
      - name: Fix unsigned tags
        id: fix-unsigned
        uses: CLDMV/.github/.github/actions/git/steps/fix-unsigned-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CI_DEBUG: ${{ inputs.debug && 'true' || 'false' }}
        with:
          debug: ${{ inputs.debug }}
          tags_detailed: ${{ steps.rescan-after-bot-sigs.outputs.tags_detailed }}
          sign: ${{ inputs.sign || 'auto' }}
          annotate: ${{ inputs.annotate }}
          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}

      # Step 7: Re-scan tags after unsigned tag fixes
      - name: Re-scan tags after unsigned tag fixes
        id: rescan-after-unsigned
        uses: CLDMV/.github/.github/actions/git/steps/get-detailed-tags@v1
        with:
          debug: ${{ inputs.debug }}
          max_tags: ${{ inputs.max_tags }}
          max_major_versions: ${{ inputs.max_major_versions }}
          max_minor_versions: ${{ inputs.max_minor_versions }}
          bot_patterns: ${{ inputs.bot_patterns }}
          include_patterns: ${{ inputs.include_patterns }}
          exclude_patterns: ${{ inputs.exclude_patterns }}

      # Step 8: Fix orphaned tags (using fresh tag data)
      - name: Fix orphaned tags
        id: fix-orphaned
        uses: CLDMV/.github/.github/actions/git/steps/fix-orphaned-tags@v1
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CI_DEBUG: ${{ inputs.debug && 'true' || 'false' }}
        with:
          debug: ${{ inputs.debug }}
          tags_detailed: ${{ steps.rescan-after-unsigned.outputs.tags_detailed }}
          # forward identity & GPG only if toggled on
          tagger_name: ${{ inputs.use_gpg && secrets.TAGGER_NAME   || '' }}
          tagger_email: ${{ inputs.use_gpg && secrets.TAGGER_EMAIL  || '' }}
          gpg_private_key: ${{ inputs.use_gpg && secrets.GPG_PRIVATE_KEY || '' }}
          gpg_passphrase: ${{ inputs.use_gpg && secrets.GPG_PASSPHRASE  || '' }}

      # Step 9: Final scan for summary
      - name: Final tag scan for summary
        id: final-scan
        uses: CLDMV/.github/.github/actions/git/steps/get-detailed-tags@v1
        with:
          debug: ${{ inputs.debug }}
          max_tags: ${{ inputs.max_tags }}
          max_major_versions: ${{ inputs.max_major_versions }}
          max_minor_versions: ${{ inputs.max_minor_versions }}
          bot_patterns: ${{ inputs.bot_patterns }}
          include_patterns: ${{ inputs.include_patterns }}
          exclude_patterns: ${{ inputs.exclude_patterns }}

      # Step 10: Summarize all processing
      - name: Summarize processing
        id: summarize
        run: |
          echo "ðŸ”„ Unified Tag Health Summary for ${{ inputs.package_name }}:"

          INITIAL_COUNT="${{ steps.get-tags.outputs.tags_count }}"
          FINAL_COUNT="${{ steps.final-scan.outputs.tags_count }}"
          BOT_FIXED="${{ steps.fix-bot-sigs.outputs.fixed_count }}"
          UNSIGNED_FIXED="${{ steps.fix-unsigned.outputs.fixed_count }}"
          ORPHANED_FIXED="${{ steps.fix-orphaned.outputs.fixed_count }}"
          MAJOR_UPDATED="${{ steps.update-major-tags.outputs.updated == 'true' && '1' || '0' }}"

          TOTAL_FIXED=$((BOT_FIXED + UNSIGNED_FIXED + ORPHANED_FIXED + MAJOR_UPDATED))

          echo "  ðŸ“Š Initial tags: $INITIAL_COUNT"
          echo "  ðŸ“Œ Major/minor tags updated: $MAJOR_UPDATED (ran first)"
          echo "  ðŸ¤– Bot signature fixes: $BOT_FIXED"
          echo "  ðŸ” Unsigned tag fixes: $UNSIGNED_FIXED"
          echo "  ðŸ”— Orphaned tag fixes: $ORPHANED_FIXED"
          echo "  ï¿½ Final tag count: $FINAL_COUNT"
          echo "  âœ… Total operations: $TOTAL_FIXED"

          SUMMARY="Processed $INITIAL_COUNT tags for ${{ inputs.package_name }}. Updated $MAJOR_UPDATED major/minor tags (first), then fixed: $BOT_FIXED bot signatures, $UNSIGNED_FIXED unsigned tags, $ORPHANED_FIXED orphaned tags. Final count: $FINAL_COUNT. Total operations: $TOTAL_FIXED"

          echo "total-processed=$INITIAL_COUNT" >> $GITHUB_OUTPUT
          echo "total-fixed=$TOTAL_FIXED" >> $GITHUB_OUTPUT
          echo "processing-summary=$SUMMARY" >> $GITHUB_OUTPUT
