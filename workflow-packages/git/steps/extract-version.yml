name: "Extract Version from PR"
description: "Extract version number from PR title or check for release label"

outputs:
  should-release:
    description: "Whether this is a release PR"
    value: ${{ steps.check.outputs.should-release }}
  version:
    description: "Extracted version number"
    value: ${{ steps.check.outputs.version }}
  is-prerelease:
    description: "Whether this is a prerelease"
    value: ${{ steps.check.outputs.is-prerelease }}

runs:
  using: "composite"
  steps:
    - name: Extract version from PR
      id: check
      shell: bash
      run: |
        # Extract version from PR title or check for release label
        PR_TITLE="${{ github.event.pull_request.title }}"
        HAS_RELEASE_LABEL="${{ contains(github.event.pull_request.labels.*.name, 'release') }}"

        echo "PR Title: $PR_TITLE"
        echo "Has release label: $HAS_RELEASE_LABEL"

        # Check if title starts with "release:" and extract version
        if [[ $PR_TITLE =~ ^release:\ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
          VERSION="${BASH_REMATCH[1]}"
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=false" >> $GITHUB_OUTPUT
          echo "üöÄ Release PR merged for version $VERSION (from title)"
        # Check if has release label (fallback for manual releases)
        elif [[ "$HAS_RELEASE_LABEL" == "true" ]]; then
          # Try to extract version from title even if it doesn't start with "release:"
          if [[ $PR_TITLE =~ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            echo "üöÄ Release PR merged for version $VERSION (from label + title)"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "‚ùå Release label found but could not extract version from title: $PR_TITLE"
          fi
        else
          echo "should-release=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Not a release PR (title doesn't start with 'release:' and no release label)"
        fi
